

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Bayesian Quadrature: Variance Derivation &mdash; bayesian_quadrature 0.0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="bayesian_quadrature 0.0.1 documentation" href="index.html" />
    <link rel="next" title="Bayesian Quadrature: Expected Variance" href="expected_variance_derivation.html" />
    <link rel="prev" title="Bayesian Quadrature: Mean Derivation" href="mean_derivation.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="expected_variance_derivation.html" title="Bayesian Quadrature: Expected Variance"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="mean_derivation.html" title="Bayesian Quadrature: Mean Derivation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">bayesian_quadrature 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="bayesian-quadrature-variance-derivation">
<h1>Bayesian Quadrature: Variance Derivation<a class="headerlink" href="#bayesian-quadrature-variance-derivation" title="Permalink to this headline">¶</a></h1>
<p>We want to compute Equation 10 from :</p>
<div class="math">
\[V_Z = \int\int m_\ell(x)C_{\log \ell}(x, x^\prime)m_\ell(x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\]</div>
<p>Because in practice actually use the transform
<span class="math">\(\log\left(\frac{\ell(x)}{\gamma} + 1\right)\)</span>, this becomes:</p>
<div class="math">
\[V_Z = \int\int (m_\ell(x)+\gamma)C_{\log \ell}(x, x^\prime)(m_\ell(x^\prime)+\gamma)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime.\]</div>
<p>This quantity expands out into three terms:</p>
<div class="math">
\[V_Z=E[m_\ell C_{\log\ell}m_\ell] + 2\gamma E[m_\ell C_{\log\ell}] + \gamma^2 E[C_{\log\ell}],\]</div>
<p>where:</p>
<div class="math">
\[\begin{split}\begin{align*}
E[m_\ell C_{\log\ell}m_\ell] &amp;= \int\int m_\ell(x)C_{\log \ell}(x, x^\prime)m_\ell(x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
E[m_\ell C_{\log\ell}] &amp;= \int\int m_\ell(x)C_{\log\ell}(x, x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
E[C_{\log\ell}] &amp;= \int\int C_{\log\ell}(x, x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime.
\end{align*}\end{split}\]</div>
<p>These three terms are further expanded below.</p>
<div class="section" id="first-term">
<h2>First Term<a class="headerlink" href="#first-term" title="Permalink to this headline">¶</a></h2>
<p>We expand the first term to obtain:</p>
<div class="math">
\[\begin{split}\begin{align*}
E[m_\ell C_{\log\ell}m_\ell] &amp;= \int \int \left(K_\ell(x, x_s)K(x_s, x_s)^{-1}\ell(x_s)\right)\left(K_{\log\ell}(x, x^\prime)-K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)\right)\left(K_\ell(x^\prime, x_s)K(x_s, x_s)^{-1}\ell(x_s)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \int \int \left(K_\ell(x, x_s)\alpha_\ell(x_s)\right)\left(K_{\log\ell}(x, x^\prime)-K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)\right)\left(K_\ell(x^\prime, x_s)\alpha_\ell(x_s)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \int \int \left(K_\ell(x, x_s)\alpha_\ell(x_s)\right)K_{\log\ell}(x, x^\prime)\left(K_\ell(x^\prime, x_s)\alpha_\ell(x_s)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;\ \ \ \ - \int \int \left(K_\ell(x, x_s)\alpha_\ell(x_s)\right) K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)\left(K_\ell(x^\prime, x_s)\alpha_\ell(x_s)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime,
\end{align*}\end{split}\]</div>
<p>where <span class="math">\(\alpha_\ell(x_s)=K_\ell(x_s, x_s)^{-1}\ell(x_s)\)</span>.</p>
<p>The first part of this is:</p>
<div class="math">
\[\begin{split}\begin{align*}
\int \int &amp;\left(K_\ell(x, x_s)\alpha_\ell(x_s)\right)K_{\log\ell}(x, x^\prime)\left(K_\ell(x^\prime, x_s)\alpha_\ell(x_s)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \alpha_\ell(x_s)^\top \left(\int\int K_\ell(x_s, x)K_{\log\ell}(x, x^\prime)K_\ell(x^\prime, x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\right)\alpha_\ell(x_s)
\end{align*}\end{split}\]</div>
<p>And the second part is:</p>
<div class="math">
\[\begin{split}\begin{align*}
- \int \int &amp;\left(K_\ell(x, x_s)\alpha_\ell(x_s)\right) K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)\left(K_\ell(x^\prime, x_s)\alpha_\ell(x_s)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= - \int \int \left(K_\ell(x, x_s)\alpha_\ell(x_s)\right) K_{\log\ell}(x, x_s)\left(L_{\log\ell}(x_s, x_s)^{-1}\right)^\top L_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)\left(K_\ell(x^\prime, x_s)\alpha_\ell(x_s)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= - \int \int \left(L_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x) K_\ell(x, x_s)\alpha_\ell(x_s) \right)^\top \left(L_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)K_\ell(x^\prime, x_s)\alpha_\ell(x_s)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= - \left[L_{\log\ell}(x_s, x_s)^{-1}\left(\int K_{\log\ell}(x_s, x) K_\ell(x, x_s)p(x)\ \mathrm{d}x \right)\alpha_\ell(x_s)\right]^\top\left[L_{\log\ell}(x_s, x_s)^{-1}\left(\int K_{\log\ell}(x_s, x) K_\ell(x, x_s)p(x)\ \mathrm{d}x \right)\alpha_\ell(x_s)\right]\\\\
&amp;= -\beta(x_s)^\top\beta(x_s),
\end{align*}\end{split}\]</div>
<p>where
<span class="math">\(\beta(x_s)=L_{\log\ell}(x_s, x_s)^{-1}\left(\int K_{\log\ell}(x_s, x) K_\ell(x, x_s)p(x)\ \mathrm{d}x \right)\alpha_\ell(x_s)\)</span>
and <span class="math">\(L_{\log\ell}(x_s, x_s)\)</span> is the Cholesky decomposition of
<span class="math">\(K_{\log\ell}(x_s, x_s)\)</span>.</p>
<p>Putting these together, we obtain:</p>
<div class="math">
\[E[m_\ell C_{\log\ell}m_\ell]=\alpha_\ell(x_s)^\top \left(\int\int K_\ell(x_s, x)K_{\log\ell}(x, x^\prime)K_\ell(x^\prime, x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\right)\alpha_\ell(x_s)-\beta(x_s)^\top\beta(x_s)\]</div>
<div class="section" id="first-integral">
<h3>First integral<a class="headerlink" href="#first-integral" title="Permalink to this headline">¶</a></h3>
<p>Assuming the kernels are Gaussian kernels, and <span class="math">\(p(x)\)</span> is also
Gaussian with mean <span class="math">\(\mu\)</span> and covariance <span class="math">\(\Sigma\)</span>, we can
derive the integrals analytically. For readability, let <span class="math">\(a=x_s\)</span>,
<span class="math">\(b=x\)</span>, and <span class="math">\(c=x^\prime\)</span>. Then:</p>
<div class="math">
\[\begin{split}\begin{align*}
\int\int &amp; K_\ell(a_{i}, b)K_{\log\ell}(b, c)K_\ell(c, a_{j})p(b)p(c)\ \mathrm{d}b\ \mathrm{d}c\\\\
&amp;= h_1^4 h_2^2 \int\int \mathcal{N}\left(a_{i}\ \big\vert\  b, W_\ell\right)\mathcal{N}\left(b\ \big\vert\  c, W_{\log\ell}\right)\mathcal{N}\left(c\ \big\vert\  a_{j}, W_\ell\right)\mathcal{N}\left(b\ \big\vert\  \mu, \Sigma\right)\mathcal{N}\left(c\ \big\vert\  \mu, \Sigma\right)\ \mathrm{d}b\ \mathrm{d}c\\\\
\end{align*}\end{split}\]</div>
<p>From , we have:</p>
<div class="math">
\[\mathcal{N}\left(a_{i}\ \big\vert\  b, W_\ell\right)\mathcal{N}\left(b\ \big\vert\  \mu, \Sigma\right) = \mathcal{N}\left(a_{i}\ \big\vert\  \mu, W_\ell + \Sigma\right)\mathcal{N}\left(b\ \big\vert\  \mu + \Gamma(a_{i}-\mu), \Sigma -\Gamma\Sigma\right),\]</div>
<p>where <span class="math">\(\Gamma = \Sigma(W_\ell + \Sigma)^{-1}\)</span>.</p>
<p>Using this identity for both <span class="math">\(a_{i}\)</span> and <span class="math">\(a_{j}\)</span>, we obtain:</p>
<div class="math">
\[= h_1^4 h_2^2 \mathcal{N}\left(a_{i}\ \big\vert\  \mu, W_\ell + \Sigma\right)\mathcal{N}\left(a_{j}\ \big\vert\  \mu, W_\ell+\Sigma\right)\int \mathcal{N}\left(b\ \big\vert\  \mu + \Gamma(a_{i}-\mu), \Sigma -\Gamma\Sigma\right)\int \mathcal{N}\left(b-c\ \big\vert\  0, W_{\log\ell}\right)\mathcal{N}\left(c\ \big\vert\  \mu + \Gamma(a_{j}-\mu), \Sigma -\Gamma\Sigma\right)\ \mathrm{d}b\ \mathrm{d}c\]</div>
<p>The innermost integral is a convolution, giving us:</p>
<div class="math">
\[= h_1^4 h_2^2 \mathcal{N}\left(a_{i}\ \big\vert\  \mu, W_\ell + \Sigma\right)\mathcal{N}\left(a_{j}\ \big\vert\  \mu, W_\ell+\Sigma\right)\int \mathcal{N}\left(b\ \big\vert\  \mu + \Gamma(a_{i}-\mu), \Sigma -\Gamma\Sigma\right) \mathcal{N}\left(b\ \big\vert\  \mu + \Gamma(a_{j}-\mu), W_{\log\ell} + \Sigma -\Gamma\Sigma\right)\ \mathrm{d}b\]</div>
<p>This can also be rewritten in convolution form:</p>
<div class="math">
\[\begin{split}\begin{align*}
&amp;= h_1^4 h_2^2 \mathcal{N}\left(a_{i}\ \big\vert\  \mu, W_\ell + \Sigma\right)\mathcal{N}\left(a_{j}\ \big\vert\  \mu, W_\ell+\Sigma\right)\int \mathcal{N}\left(a_{i}-b\ \big\vert\  a_{i} - \mu - \Gamma(a_{i}-\mu), \Sigma -\Gamma W_\ell\right) \mathcal{N}\left(b\ \big\vert\  \mu + \Gamma(a_{j}-\mu), W_{\log\ell} + \Sigma -\Gamma W_\ell\right)\ \mathrm{d}b\\\\
&amp;= h_1^4 h_2^2 \mathcal{N}\left(a_{i}\ \big\vert\  \mu, W_\ell + \Sigma\right)\mathcal{N}\left(a_{j}\ \big\vert\  \mu, W_\ell+\Sigma\right) \mathcal{N}\left(a_{i}\ \big\vert\  a_{i} + \Gamma(a_{j}-a_{i}), W_{\log\ell} + 2\Sigma -2\Gamma\Sigma\right)\\\\
&amp;= h_1^4 h_2^2 \left\vert \Gamma\right\vert^{-1} \mathcal{N}\left(a_{i}\ \big\vert\  \mu, W_\ell + \Sigma\right)\mathcal{N}\left(a_{j}\ \big\vert\  \mu, W_\ell+\Sigma\right) \mathcal{N}\left(a_{i}\ \big\vert\ a_{j}, \Gamma^{-1}(W_{\log\ell} + 2\Sigma -2\Gamma\Sigma)\Gamma^{-1}\right)
\end{align*}\end{split}\]</div>
</div>
<div class="section" id="second-integral">
<h3>Second integral<a class="headerlink" href="#second-integral" title="Permalink to this headline">¶</a></h3>
<p>The integral in <span class="math">\(\beta(x)\)</span> can be expressed analytically as
follows, from :</p>
<div class="math">
\[\begin{split}\begin{align*}
\int K_{\log\ell}(x_s, x) K_\ell(x, x_s)p(x)\ \mathrm{d}x&amp;=\int h_{\log\ell}^2 h_\ell^2\mathcal{N}\left(x_{s,i}\ \big\vert\  x, W_{\log\ell}\right)\mathcal{N}\left(x_{s,j}\ \big\vert\  x, W_\ell\right)\mathcal{N}\left(x\ \big\vert\  \mu, \Sigma\right)\ \mathrm{d}x\\\\
&amp;= h_{\log\ell}^2 h_\ell^2\int\mathcal{N}\left([x_{s,i}, x_{s,j}]\ \big\vert\  [x, x], [W_{\log\ell}, 0; 0, W_\ell]\right)\mathcal{N}\left(x\ \big\vert\  \mu, \Sigma\right)\ \mathrm{d}x\\\\
&amp;= h_{\log\ell}^2 h_\ell^2 \mathcal{N}\left([x_{s,i}, x_{s,j}]\ \big\vert\  [\mu, \mu], [W_{\log\ell}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma]\right)
\end{align*}\end{split}\]</div>
</div>
</div>
<div class="section" id="second-term">
<h2>Second Term<a class="headerlink" href="#second-term" title="Permalink to this headline">¶</a></h2>
<p>The second term also expands into two parts:</p>
<div class="math">
\[\begin{split}\begin{align*}
E[m_\ell C_{\log\ell}] &amp;= \int\int m_\ell(x)C_{\log\ell}(x, x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \int\int K_\ell(x, x_s)K_\ell(x_s, x_s)^{-1}\ell(x_s)\left(K_{\log\ell}(x, x^\prime) - K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \int\int K_{\log\ell}(x^\prime, x)K_\ell(x, x_s)K_\ell(x_s, x_s)^{-1}\ell(x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime - \int\int K_{\log\ell}(x^\prime, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x)K_\ell(x, x_s)K_\ell(x_s, x_s)^{-1}\ell(x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime
\end{align*}\end{split}\]</div>
<p>The first part is just:</p>
<div class="math">
\[\begin{split}\begin{align*}
\int\int &amp; K_{\log\ell}(x^\prime, x)K_\ell(x, x_s)K_\ell(x_s, x_s)^{-1}\ell(x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \left(\int\int K_{\log\ell}(x^\prime, x)K_\ell(x, x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\right) \alpha_\ell(x_s)
\end{align*}\end{split}\]</div>
<p>The second part is:</p>
<div class="math">
\[\begin{split}\begin{align*}
- \int\int &amp; K_{\log\ell}(x^\prime, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x)K_\ell(x, x_s)K_\ell(x_s, x_s)^{-1}\ell(x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= - \left(\int\int K_{\log\ell}(x^\prime, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x)K_\ell(x, x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\right)\alpha_\ell(x_s)\\\\
&amp;= - \left(\int K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}p(x)\ \mathrm{d}x\right)\left(\int K_{\log\ell}(x_s, x)K_\ell(x, x_s)p(x)\ \mathrm{d}x\right)\alpha_\ell(x_s)\\\\
&amp;= - \left(\int K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x\right)K_{\log\ell}(x_s, x_s)^{-1}\left(\int K_{\log\ell}(x_s, x)K_\ell(x, x_s)p(x)\ \mathrm{d}x\right)\alpha_\ell(x_s)
\end{align*}\end{split}\]</div>
<p>Putting these together, we get:</p>
<div class="math">
\[E[m_\ell C_{\log\ell}]=\left[\int\int K_{\log\ell}(x^\prime, x)K_\ell(x, x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime-\left(\int K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x\right)K_{\log\ell}(x_s, x_s)^{-1}\left(\int K_{\log\ell}(x_s, x)K_\ell(x, x_s)p(x)\ \mathrm{d}x\right)\right]\alpha_\ell(x_s)\]</div>
<div class="section" id="id1">
<h3>First integral<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The first integral we need to resolve analytically is:</p>
<div class="math">
\[\int\int K_{\log\ell}(x^\prime, x)K_\ell(x, x_s)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\]</div>
<p>As above, the kernels are Gaussian kernels, and <span class="math">\(p(x)\)</span> is also
Gaussian with mean <span class="math">\(\mu\)</span> and covariance <span class="math">\(\Sigma\)</span>. For
readability, let <span class="math">\(a=x_s\)</span>, <span class="math">\(b=x\)</span>, and <span class="math">\(c=x^\prime\)</span>.
Then:</p>
<div class="math">
\[\begin{split}\begin{align*}
h_{\log\ell}^2 h_\ell^2\int\int &amp;\mathcal{N}\left(c\ \big\vert\ b, W_{\log\ell}\right)\mathcal{N}\left(b\ \big\vert\ a, W_\ell\right)\mathcal{N}\left(b\ \big\vert\ \mu, \Sigma\right)\mathcal{N}\left(c\ \big\vert\ \mu, \Sigma\right)\ \mathrm{d}b\ \mathrm{d}c\\\\
&amp;= h_{\log\ell}^2 h_\ell^2\int \mathcal{N}\left(b\ \big\vert\ a, W_\ell\right)\mathcal{N}\left(b\ \big\vert\ \mu, \Sigma\right)\int\mathcal{N}\left(b - c\ \big\vert\ 0, W_{\log\ell}\right)\mathcal{N}\left(c\ \big\vert\ \mu, \Sigma\right)\ \mathrm{d}b\ \mathrm{d}c
\end{align*}\end{split}\]</div>
<p>The innermost integral is a convolution, giving:</p>
<div class="math">
\[= h_{\log\ell}^2 h_\ell^2\int \mathcal{N}\left(b\ \big\vert\ a, W_\ell\right)\mathcal{N}\left(b\ \big\vert\ \mu, \Sigma\right)\mathcal{N}\left(b\ \big\vert\ \mu, W_{\log\ell}+\Sigma\right)\ \mathrm{d}b\]</div>
<p>From , we have:</p>
<div class="math">
\[\begin{split}\begin{align*}
\mathcal{N}\left(\mu\ \big\vert\  b, W_{\log\ell}+\Sigma\right)\mathcal{N}\left(b\ \big\vert\  \mu, \Sigma\right) &amp;= \mathcal{N}\left(\mu\ \big\vert\  \mu, W_{\log\ell} + 2\Sigma\right)\mathcal{N}\left(b\ \big\vert\  \mu + \Sigma(W_{\log\ell}+2\Sigma)^{-1}(\mu-\mu), \Sigma -\Sigma(W_{\log\ell}+2\Sigma)^{-1}\Sigma\right)\\\\
&amp;= \mathcal{N}\left(0\ \big\vert\ 0, W_{\log\ell}+2\Sigma\right)\mathcal{N}\left(b\ \big\vert\ \mu, \Sigma -\Sigma(W_{\log\ell}+2\Sigma)^{-1}\Sigma\right)
\end{align*}\end{split}\]</div>
<p>Plugging this in, we obtain another convolution:</p>
<div class="math">
\[\begin{split}\begin{align*}
&amp;= h_{\log\ell}^2 h_\ell^2\mathcal{N}\left(0\ \big\vert\ 0, W_{\log\ell}+2\Sigma\right)\int \mathcal{N}\left(a-b\ \big\vert\ 0, W_\ell\right) \mathcal{N}\left(b\ \big\vert\ \mu, \Sigma -\Sigma(W_{\log\ell}+2\Sigma)^{-1}\Sigma\right)\\\\
&amp;= h_{\log\ell}^2 h_\ell^2\mathcal{N}\left(0\ \big\vert\ 0, W_{\log\ell}+2\Sigma\right)\mathcal{N}\left(a\ \big\vert\ \mu, W_\ell+\Sigma -\Sigma(W_{\log\ell}+2\Sigma)^{-1}\Sigma\right)
\end{align*}\end{split}\]</div>
</div>
<div class="section" id="id2">
<h3>Second Integral<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The second integral is:</p>
<div class="math">
\[\begin{split}\begin{align*}
\int K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x &amp;= h_{\log\ell}^2 \int \mathcal{N}\left( x \ \big\vert\ x_s, W_{\log\ell} \right)\mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right)\ \mathrm{d}x\\\\
&amp;= h_{\log\ell}^2 \mathcal{N}\left( x_s \ \big\vert\ \mu, W_{\log\ell}+\Sigma \right)
\end{align*}\end{split}\]</div>
</div>
<div class="section" id="third-integral">
<h3>Third Integral<a class="headerlink" href="#third-integral" title="Permalink to this headline">¶</a></h3>
<p>The third integral is:</p>
<div class="math">
\[\begin{split}\begin{align*}
\int &amp; K_{\log\ell}(x_s, x)K_\ell(x, x_s)p(x)\ \mathrm{d}x\\\\
&amp;= h_{\log\ell}^2 h_\ell^2 \int \mathcal{N}\left( x_{s,i} \ \big\vert\ x, W_{\log\ell} \right)\mathcal{N}\left( x \ \big\vert\ x_{s,j}, W_\ell \right)\mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right)\ \mathrm{d}x\\\\
&amp;= h_{\log\ell}^2 h_\ell^2 \int \mathcal{N}\left( [x_{s,i}, x_{s,j}] \ \big\vert\ [x, x], [W_{\log\ell}, 0; 0, W_{\ell}] \right)\mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right)\ \mathrm{d}x\\\\
&amp;= h_{\log\ell}^2 h_\ell^2 \mathcal{N}\left( [x_{s,i}, x_{s,j}] \ \big\vert\ [\mu, \mu], [W_{\log\ell}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma] \right)
\end{align*}\end{split}\]</div>
</div>
</div>
<div class="section" id="third-term">
<h2>Third Term<a class="headerlink" href="#third-term" title="Permalink to this headline">¶</a></h2>
<p>The third term is:</p>
<div class="math">
\[\begin{split}\begin{align*}
E[C_{\log\ell}] &amp;= \int\int C_{\log\ell}(x, x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \int\int \left(K_{\log\ell}(x, x^\prime) - K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)\right)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \int\int K_{\log\ell}(x, x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime - \int\int K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}K_{\log\ell}(x_s, x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \int\int K_{\log\ell}(x, x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime - \left(\int K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x\right)K_{\log\ell}(x_s, x_s)^{-1}\left(\int K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x\right)^\top
\end{align*}\end{split}\]</div>
<div class="section" id="id3">
<h3>First integral<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The first integral is:</p>
<div class="math">
\[\begin{split}\begin{align*}
\int\int K_{\log\ell}(x, x^\prime)p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime &amp;= h_{\log\ell}^2\int\int \mathcal{N}\left( x \ \big\vert\ x^\prime, W_{\log\ell} \right)\mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right)\mathcal{N}\left( x^\prime \ \big\vert\ \mu, \Sigma \right)\ \mathrm{d}x \ \mathrm{d}x^\prime\\\\
&amp;= h_{\log\ell}^2\int \mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right)\int \mathcal{N}\left( x - x^\prime \ \big\vert\ 0, W_{\log\ell} \right)\mathcal{N}\left( x^\prime \ \big\vert\ \mu, \Sigma \right)\ \mathrm{d}x \ \mathrm{d}x^\prime\\\\
&amp;= h_{\log\ell}^2\int \mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right) \mathcal{N}\left( x \ \big\vert\ \mu, W_{\log\ell}+\Sigma \right) \ \mathrm{d}\\\\
&amp;= h_{\log\ell}^2\mathcal{N}\left( \mu \ \big\vert\ \mu, W_{\log\ell}+2\Sigma \right)\\\\
&amp;= h_{\log\ell}^2\mathcal{N}\left( 0 \ \big\vert\ 0, W_{\log\ell} + 2\Sigma \right)
\end{align*}\end{split}\]</div>
</div>
<div class="section" id="second-and-third-integrals">
<h3>Second and third integrals<a class="headerlink" href="#second-and-third-integrals" title="Permalink to this headline">¶</a></h3>
<p>The other integrals are identical, and can be expressed analytically as:</p>
<div class="math">
\[\begin{split}\begin{align*}
\int K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x &amp;= h_{\log\ell}^2 \int \mathcal{N}\left( x \ \big\vert\ x_s, W_{\log\ell} \right)\mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right)\ \mathrm{d}x\\\\
&amp;= h_{\log\ell}^2 \mathcal{N}\left( x_s \ \big\vert\ \mu, W_{\log\ell}+\Sigma \right)
\end{align*}\end{split}\]</div>
</div>
</div>
<div class="section" id="variance-correction">
<h2>Variance Correction<a class="headerlink" href="#variance-correction" title="Permalink to this headline">¶</a></h2>
<p>We adjust the covariance <span class="math">\(C_{\log\ell}(x, x^\prime)\)</span> as follows:</p>
<div class="math">
\[C_{\log\ell}(x, x^\prime) = C_{\log\ell}(x, x^\prime)+\frac{\partial m_{\log\ell}(x)}{\partial\hat{W}}C_\hat{W}\frac{\partial m_{\log\ell}(x^\prime)}{\partial\hat{W}}^\top\]</div>
<p>This requires that we adjust the previously calculated variance by a
correction factor:</p>
<div class="math">
\[\begin{split}\begin{align*}
\epsilon &amp;= \int\int (m_\ell(x) + \gamma)\frac{\partial m_{\log\ell}(x)}{\partial\hat{W}}C_{\hat{W}}\frac{\partial m_{\log\ell}(x^\prime)}{\partial\hat{W}}^\top(m_\ell(x^\prime) + \gamma)^\top p(x)p(x^\prime)\ \mathrm{d}x\ \mathrm{d}x^\prime\\\\
&amp;= \left(\int (m_\ell(x) + \gamma)\frac{\partial m_{\log\ell}(x)}{\partial\hat{W}}p(x)\ \mathrm{d}x\right)C_{\hat{W}}\left(\int (m_\ell(x) + \gamma)\frac{\partial m_{\log\ell}(x)}{\partial\hat{W}}p(x)\ \mathrm{d}x\right)^\top\\\\
&amp;= \nu C_{\hat{W}} \nu^\top
\end{align*}\end{split}\]</div>
<p>Where <span class="math">\(\nu\)</span> is defined as:</p>
<div class="math">
\[\begin{split}\begin{align*}
\nu &amp;= \int (m_\ell(x) + \gamma)\frac{\partial m_{\log\ell}(x)}{\partial\hat{W}}p(x)\ \mathrm{d}x\\\\
&amp;= \int m_\ell(x)\frac{\partial m_{\log\ell}(x)}{\partial\hat{W}}p(x)\ \mathrm{d}x + \gamma\int \frac{\partial m_{\log\ell}(x)}{\partial\hat{W}}p(x)\ \mathrm{d}x
\end{align*}\end{split}\]</div>
<p>The derivative of the mean with respect to <span class="math">\(\hat{W}\)</span> is:</p>
<div class="math">
\[\begin{split}\begin{align*}
\frac{\partial m_{\log\ell}(x)}{\partial\hat{W}} &amp;= \frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}K_{\log\ell}(x_s, x_s)^{-1}\log\ell(x_s) - K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}\frac{\partial K_{\log\ell}(x_s, x_s)}{\partial\hat{W}}K_{\log\ell}(x_s, x_s)^{-1}\log\ell(x_s)\\\\
&amp;= \frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}\alpha_{\log\ell}(x_s) - K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}\frac{\partial K_{\log\ell}(x_s, x_s)}{\partial\hat{W}}\alpha_{\log\ell}(x_s)
\end{align*}\end{split}\]</div>
<p>So the first term of <span class="math">\(\nu\)</span> becomes:</p>
<div class="math">
\[\begin{split}\begin{align*}
\int &amp; K_\ell(x,x_s)\alpha_\ell(x_s)\frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}\alpha_{\log\ell}(x_s)p(x)\ \mathrm{d}x - \int K_\ell(x,x_s)\alpha_\ell(x_s)K_{\log\ell}(x, x_s)K_{\log\ell}(x_s, x_s)^{-1}\frac{\partial K_{\log\ell}(x_s, x_s)}{\partial\hat{W}}\alpha_{\log\ell}(x_s)p(x)\ \mathrm{d}x\\\\
&amp;= \alpha_\ell(x_s)^\top \left[\int K_\ell(x_s,x)\frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}p(x)\ \mathrm{d}x - \left(\int K_\ell(x_s,x)K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x\right)K_{\log\ell}(x_s, x_s)^{-1}\frac{\partial K_{\log\ell}(x_s, x_s)}{\partial\hat{W}}\right] \alpha_{\log\ell}(x_s)\\\\
&amp;= \alpha_\ell(x_s)^\top \left[\int K_\ell(x_s,x)\frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}p(x)\ \mathrm{d}x - \left(\int K_\ell(x_s,x)K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x\right)\zeta(x_s)\right] \alpha_{\log\ell}(x_s),
\end{align*}\end{split}\]</div>
<p>where
<span class="math">\(\zeta(x_s)=K_{\log\ell}(x_s, x_s)^{-1}\frac{\partial K_{\log\ell}(x_s, x_s)}{\partial\hat{W}}\)</span>.</p>
<p>And the second term of <span class="math">\(\nu\)</span> becomes:</p>
<div class="math">
\[\begin{split}\begin{align*}
\gamma\int &amp;\frac{\partial m_{\log\ell}(x)}{\partial\hat{W}}p(x)\ \mathrm{d}x\\\\
&amp;= \gamma \left(\int\frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}\alpha_{\log\ell}(x_s)p(x)\ \mathrm{d}x - \int K_{\log\ell}(x, x_s)\zeta(x_s)\alpha_{\log\ell}(x_s)p(x)\ \mathrm{d}x\right)\\\\
&amp;= \gamma \left[\int\frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}p(x)\ \mathrm{d}x - \left(\int K_{\log\ell}(x, x_s)p(x)\ \mathrm{d}x\right) \zeta(x_s)\right]\alpha_{\log\ell}(x_s)
\end{align*}\end{split}\]</div>
<p>Putting these together, we have:</p>
<div class="math">
\[\begin{split}\begin{align*}
\nu = &amp;\alpha_\ell(x_s)^\top \left( \int K_\ell(x_s, x)\frac{\partial K_{\log\ell}(x, x_s)}{\partial \hat{W}}p(x) \ \mathrm{d}x\right)\alpha_{\log\ell}(x_s)\\\\
&amp;\ \ - \alpha_\ell(x_s)^\top \left(\int K_\ell(x_s, s)K_{\log\ell}(x, x_s)p(x) \ \mathrm{d}x\right)\zeta(x_s)\alpha_{\log\ell}(x_s)\\\\
&amp;\ \ + \gamma\left(\int\frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}p(x) \ \mathrm{d}x\right)\alpha_{\log\ell}(x_s)\\\\
&amp;\ \ - \gamma\left(\int K_{\log\ell}(x, x_s)p(x) \ \mathrm{d}x\right)\zeta(x_s)\alpha_{\log\ell}(x_s)
\end{align*}\end{split}\]</div>
<p>The analytic form of the second and fourth integrals is defined above.
The first and third integrals are defined as follows, using the
following identity:</p>
<div class="math">
\[\begin{align*}
\frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}} = K_{\log\ell}(x, x_s) \left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right)
\end{align*}\]</div>
</div>
<div class="section" id="id4">
<h2>First integral<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<div class="math">
\[\begin{split}\begin{align*}
\int &amp; K_\ell(x_s^\prime, x)\frac{\partial K_{\log\ell}(x, x_s)}{\partial \hat{W}}p(x) \ \mathrm{d}x = \int K_\ell(x_s^\prime, x)K_{\log\ell}(x, x_s)p(x) \left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
&amp;= \int\mathcal{N}\left( x_s^\prime \ \big\vert\ x, W_\ell \right)\mathcal{N}\left( x_s \ \big\vert\ x, \hat{W} \right)\mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
&amp;= \mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W}+\Sigma \right)\int \mathcal{N}\left( x_s^\prime \ \big\vert\ x, W_\ell \right)\mathcal{N}\left( x \ \big\vert\ \mu + A(x_s-\mu), B \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x,
\end{align*}\end{split}\]</div>
<p>where <span class="math">\(A=\Sigma(\hat{W}+\Sigma)^{-1}\)</span> and
<span class="math">\(B=\Sigma-A\Sigma=\Sigma-\Sigma(\hat{W}+\Sigma)^{-1}\Sigma\)</span>.</p>
<div class="math">
\[\begin{split}\begin{align*}
&amp;= \mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W}+\Sigma \right)\mathcal{N}\left( x_s^\prime \ \big\vert\ \mu+A(x_s-\mu),B+W_\ell \right)\int \mathcal{N}\left( x \ \big\vert\ \mu +A(x_s-\mu)+C(x_s^\prime-\mu-A(x_s-\mu)), B-CB \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
&amp;= \mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W}+\Sigma \right)\mathcal{N}\left( x_s^\prime \ \big\vert\ \mu+A(x_s-\mu),B+W_\ell \right)\int \mathcal{N}\left( x \ \big\vert\ \mu +A(x_s-\mu)+C(x_s^\prime-\mu-A(x_s-\mu)), B-CB \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
\end{align*}\end{split}\]</div>
<p>where
<span class="math">\(C=B(B+W_\ell)^{-1}=(\Sigma-\Sigma(\hat{W}+\Sigma)^{-1}\Sigma)(\Sigma-\Sigma(\hat{W}+\Sigma)^{-1}\Sigma+W_\ell)^{-1}\)</span>.</p>
<div class="math">
\[\begin{split}\begin{align*}
&amp;= \mathcal{N}\left( [x_s, x_s^\prime] \ \big\vert\ [\mu, \mu], [\hat{W}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma] \right)\int \mathcal{N}\left( x \ \big\vert\ \mu +A(x_s-\mu)+C(x_s^\prime-\mu-A(x_s-\mu)), B-CB \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
&amp;= \mathcal{N}\left( [x_s, x_s^\prime] \ \big\vert\ [\mu, \mu], [\hat{W}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma] \right)\int \mathcal{N}\left( x - x_s\ \big\vert\ \mu -x_s+A(x_s-\mu)+C(x_s^\prime-\mu-A(x_s-\mu)), B-CB \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
&amp;= \mathcal{N}\left( [x_s, x_s^\prime] \ \big\vert\ [\mu, \mu], [\hat{W}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma] \right)\int \mathcal{N}\left( x - x_s\ \big\vert\ (A-CA-1)(x_s-\mu)+C(x_s^\prime-\mu), B-CB \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
\end{align*}\end{split}\]</div>
<p>Let <span class="math">\(y=x-x_s\)</span>, <span class="math">\(m=(A-CA-1)(x_s-\mu)+C(x_s^\prime-\mu)\)</span>, and
<span class="math">\(S=B-CB\)</span>. Then:</p>
<div class="math">
\[\begin{split}\begin{align*}
&amp;= \mathcal{N}\left( [x_s, x_s^\prime] \ \big\vert\ [\mu, \mu], [\hat{W}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma] \right)\int \mathcal{N}\left( y \ \big\vert\ m, S \right)\left( -\frac{1}{2}\hat{W}^{-1}+\frac{1}{2}\hat{W}^{-1}yy^\top\hat{W}^{-1} \right) \ \mathrm{d}y
\end{align*}\end{split}\]</div>
<p>From , we have that
<span class="math">\(E \left[ (Ay)(Ay)^\top \right]=A(S+mm^\top)A^\top\)</span>, where
<span class="math">\(y\sim \mathcal{N}\left( m, S \right)\)</span>. Then:</p>
<div class="math">
\[\begin{split}\begin{align*}
&amp;= \mathcal{N}\left( [x_s, x_s^\prime] \ \big\vert\ [\mu, \mu], [\hat{W}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma] \right)\left( - \frac{1}{2}\hat{W}^{-1} + \frac{1}{2}E\left[(\hat{W}^{-1}y)(\hat{W}^{-1}y)^\top\right] \right)\\\\
&amp;=\mathcal{N}\left( [x_s, x_s^\prime] \ \big\vert\ [\mu, \mu], [\hat{W}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma] \right)\left( - \frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(S+mm^\top)\hat{W}^{-1}\right)\\\\
&amp;= \mathcal{N}\left( [x_s, x_s^\prime] \ \big\vert\ [\mu, \mu], [\hat{W}+\Sigma, \Sigma; \Sigma, W_\ell+\Sigma] \right)\left[ - \frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}\left( B-CB+\left((A-CA-1)(x_s-\mu)+C(x_s^\prime-\mu)\right)\left((A-CA-1)(x_s-\mu)+C(x_s^\prime-\mu)\right)^\top\right)\hat{W}^{-1}\right]
\end{align*}\end{split}\]</div>
</div>
<div class="section" id="id5">
<h2>Third integral<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<div class="math">
\[\begin{split}\begin{align*}
\int\frac{\partial K_{\log\ell}(x, x_s)}{\partial\hat{W}}p(x) \ \mathrm{d}x &amp;= \int K_{\log\ell}(x, x_s)p(x) \left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
&amp;= \int \mathcal{N}\left( x_s \ \big\vert\ x, \hat{W} \right) \mathcal{N}\left( x \ \big\vert\ \mu, \Sigma \right) \left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right) \ \mathrm{d}x\\\\
&amp;= \mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W} + \Sigma \right)\int \mathcal{N}\left( x \ \big\vert\ \mu + \Sigma(\hat{W} + \Sigma)^{-1}(x_s - \mu), \Sigma - \Sigma(\hat{W} + \Sigma)^{-1}\Sigma \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right)\ \mathrm{d}x\\\\
&amp;= \mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W} + \Sigma \right)\int \mathcal{N}\left( x -x_s\ \big\vert\ (\Sigma(\hat{W} + \Sigma)^{-1}-1)(x_s - \mu), \Sigma - \Sigma(\hat{W} + \Sigma)^{-1}\Sigma \right)\left( -\frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(x - x_s)(x-x_s)^\top\hat{W}^{-1} \right)\ \mathrm{d}x
\end{align*}\end{split}\]</div>
<p>Let <span class="math">\(y=x-x_s\)</span>, <span class="math">\(m=(\Sigma(\hat{W}+\Sigma)^{-1}-1)(x_s-\mu)\)</span>,
and <span class="math">\(S=\Sigma-\Sigma(\hat{W}+\Sigma)^{-1}\Sigma\)</span>. Then:</p>
<div class="math">
\[\begin{split}\begin{align*}
&amp;= \mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W} + \Sigma \right) \int \mathcal{N}\left( y \ \big\vert\ m, S \right)\left( - \frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}yy^\top\hat{W}^{-1} \right) \ \mathrm{d}y
\end{align*}\end{split}\]</div>
<p>From , we have that
<span class="math">\(E \left[ (Ay)(Ay)^\top \right]=A(S+mm^\top)A^\top\)</span>, where
<span class="math">\(y\sim \mathcal{N}\left( m, S \right)\)</span>. Then:</p>
<div class="math">
\[\begin{split}\begin{align*}
&amp;= \mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W} + \Sigma \right)\left( - \frac{1}{2}\hat{W}^{-1} + \frac{1}{2}E\left[(\hat{W}^{-1}y)(\hat{W}^{-1}y)^\top\right] \right)\\\\
&amp;=\mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W} + \Sigma \right)\left( - \frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}(S+mm^\top)\hat{W}^{-1}\right)\\\\
&amp;= \mathcal{N}\left( x_s \ \big\vert\ \mu, \hat{W} + \Sigma \right)\left[ - \frac{1}{2}\hat{W}^{-1} + \frac{1}{2}\hat{W}^{-1}\left(\Sigma-\Sigma(\hat{W}+\Sigma)^{-1}\Sigma + \left( \Sigma(\hat{W}+\Sigma)^{-1}-1\right)(x_s-\mu)(x_s-\mu)^\top \left( \Sigma(\hat{W}+\Sigma)^{-1}\Sigma-1 \right)\right)\hat{W}^{-1}\right]
\end{align*}\end{split}\]</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Bayesian Quadrature: Variance Derivation</a><ul>
<li><a class="reference internal" href="#first-term">First Term</a><ul>
<li><a class="reference internal" href="#first-integral">First integral</a></li>
<li><a class="reference internal" href="#second-integral">Second integral</a></li>
</ul>
</li>
<li><a class="reference internal" href="#second-term">Second Term</a><ul>
<li><a class="reference internal" href="#id1">First integral</a></li>
<li><a class="reference internal" href="#id2">Second Integral</a></li>
<li><a class="reference internal" href="#third-integral">Third Integral</a></li>
</ul>
</li>
<li><a class="reference internal" href="#third-term">Third Term</a><ul>
<li><a class="reference internal" href="#id3">First integral</a></li>
<li><a class="reference internal" href="#second-and-third-integrals">Second and third integrals</a></li>
</ul>
</li>
<li><a class="reference internal" href="#variance-correction">Variance Correction</a></li>
<li><a class="reference internal" href="#id4">First integral</a></li>
<li><a class="reference internal" href="#id5">Third integral</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="mean_derivation.html"
                        title="previous chapter">Bayesian Quadrature: Mean Derivation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="expected_variance_derivation.html"
                        title="next chapter">Bayesian Quadrature: Expected Variance</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/variance_derivation.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="expected_variance_derivation.html" title="Bayesian Quadrature: Expected Variance"
             >next</a> |</li>
        <li class="right" >
          <a href="mean_derivation.html" title="Bayesian Quadrature: Mean Derivation"
             >previous</a> |</li>
        <li><a href="index.html">bayesian_quadrature 0.0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Jessica B. Hamrick.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>